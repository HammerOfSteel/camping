name: Deploy to Oracle Host

on:
  workflow_dispatch:
    inputs:
      theme:
        description: 'Theme Selection'
        required: true
        default: 'nordic-standard'
        type: choice
        options:
          - nordic-standard
          - nordic-minimal
          - adventure-bold
      enable_email:
        description: 'Enable Email Notifications'
        required: false
        default: false
        type: boolean

env:
  DEPLOY_HOST: 129.151.193.219
  DEPLOY_USER: ubuntu
  DEPLOY_PATH: /home/ubuntu/littlelakehill
  SERVICE_NAME: lits_camping
  HOST_PORT: 3002
  CONTAINER_PORT: 3000
  DOMAIN: littlelakehill.dancingsalamanders.com

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to Oracle Host
        env:
          SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          THEME: ${{ github.event.inputs.theme }}
          ENABLE_EMAIL: ${{ github.event.inputs.enable_email }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.DEPLOY_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

          # Create deployment script with all variables pre-substituted
          cat > deploy.sh << 'SCRIPT_EOF'
          #!/bin/bash
          set -e
          
          DEPLOY_PATH="${DEPLOY_PATH}"
          THEME="${THEME}"
          ENABLE_EMAIL="${ENABLE_EMAIL}"
          DB_PASSWORD="${DB_PASSWORD}"
          NEXTAUTH_SECRET="${NEXTAUTH_SECRET}"
          DOMAIN="${DOMAIN}"
          REPO="HammerOfSteel/camping"
          REPO_BRANCH="main"
          
          echo "üöÄ Deploying Lits Camping to oracle host..."
          echo "   Domain: $DOMAIN"
          echo "   Theme: $THEME"
          echo "   Email Notifications: $ENABLE_EMAIL"
          echo "   Path: $DEPLOY_PATH"
          
          # Check if directory exists and has .git
          if [ -d "$DEPLOY_PATH/.git" ]; then
            echo "üìÅ Updating existing repository..."
            cd "$DEPLOY_PATH"
            git fetch origin "$REPO_BRANCH"
            git checkout -f origin/"$REPO_BRANCH"
          else
            echo "üìÅ Creating new deployment directory..."
            # Create parent directory if needed
            mkdir -p "$(dirname "$DEPLOY_PATH")"
            # Clone the repository
            git clone --branch "$REPO_BRANCH" --depth 1 https://github.com/"$REPO".git "$DEPLOY_PATH"
            cd "$DEPLOY_PATH"
          fi
          
          # Create .env file with configuration
          cat > .env << 'ENVEOF'
NODE_ENV=production
NEXT_PUBLIC_THEME=$THEME
NEXT_PUBLIC_SITE_NAME=Lits Camping
NEXT_PUBLIC_SITE_URL=https://$DOMAIN

# Database Configuration
DB_USER=litscamping
DB_PASSWORD=$DB_PASSWORD
DB_NAME=lits_camping
DATABASE_URL=postgresql://litscamping:$DB_PASSWORD@db:5432/lits_camping

# Authentication
NEXTAUTH_SECRET=$NEXTAUTH_SECRET
NEXTAUTH_URL=https://$DOMAIN
ADMIN_PASSWORD=admin123

# Email Notifications
ENABLE_EMAIL_NOTIFICATIONS=$ENABLE_EMAIL
EMAIL_SMTP_HOST=smtp.gmail.com
EMAIL_SMTP_PORT=587
EMAIL_SMTP_USER=your-email@gmail.com
EMAIL_SMTP_PASS=your-app-password

# Analytics (optional)
NEXT_PUBLIC_ANALYTICS_ENABLED=false
NEXT_PUBLIC_API_URL=https://$DOMAIN/api

# Booking System
NEXT_PUBLIC_SIRVOY_BOOKING_URL=https://5336c06044bd2.sirvoy.me/en
ENVEOF
          
          echo "‚úÖ Environment variables configured"
          echo "   Theme: $THEME"
          echo "   Email Notifications: $ENABLE_EMAIL"
          
          # Pull and restart containers
          echo "üê≥ Pulling latest Docker images and restarting containers..."
          sudo docker-compose down --remove-orphans || true
          sudo docker-compose up -d
          
          echo "‚è≥ Waiting for containers to be healthy..."
          sleep 15
          
          # Check container status
          echo "üìã Container status:"
          sudo docker-compose ps
          
          echo "‚úÖ Deployment complete!"
          SCRIPT_EOF
          
          chmod +x deploy.sh
          
          # Copy script to host and run with proper variable passing
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no deploy.sh ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }}:~/deploy_littlelakehill.sh
          
          # Run the script with environment variables exported
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} << 'REMOTE_EOF'
          export DEPLOY_PATH="/home/ubuntu/littlelakehill"
          export THEME="$THEME"
          export ENABLE_EMAIL="$ENABLE_EMAIL"
          export DB_PASSWORD="$DB_PASSWORD"
          export NEXTAUTH_SECRET="$NEXTAUTH_SECRET"
          export DOMAIN="littlelakehill.dancingsalamanders.com"
          bash ~/deploy_littlelakehill.sh
          REMOTE_EOF

      - name: Setup Nginx & SSL Certificates
        env:
          SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Create nginx and certbot setup script
          cat > setup_ssl.sh << 'SETUPEOF'
          #!/bin/bash
          set -e
          
          DOMAIN="littlelakehill.dancingsalamanders.com"
          HOST_PORT="3002"
          NGINX_CONFIG="/etc/nginx/sites-available/$DOMAIN"
          NGINX_ENABLED="/etc/nginx/sites-enabled/$DOMAIN"
          CERT_PATH="/etc/letsencrypt/live/$DOMAIN"
          
          echo "üîß Setting up Nginx reverse proxy and SSL..."
          echo "   Domain: $DOMAIN"
          echo "   Host Port: $HOST_PORT"
          
          # Install certbot if needed
          if ! command -v certbot &> /dev/null; then
            echo "üì¶ Installing certbot..."
            sudo apt-get update
            sudo apt-get install -y certbot python3-certbot-nginx
          fi
          
          # Create webroot directory for certbot verification
          sudo mkdir -p /var/www/certbot
          
          # Check certificate status and request if needed
          CERT_FILE="$CERT_PATH/fullchain.pem"
          SHOULD_RENEW=false
          
          if [ ! -f "$CERT_FILE" ]; then
            echo "üîê No SSL certificate found - requesting from Let's Encrypt..."
            SHOULD_RENEW=true
          else
            # Check expiration date
            EXPIRY_DATE=$(sudo openssl x509 -in "$CERT_FILE" -noout -enddate 2>/dev/null | cut -d= -f2)
            EXPIRY_EPOCH=$(date -d "$EXPIRY_DATE" +%s)
            CURRENT_EPOCH=$(date +%s)
            DAYS_LEFT=$(( ($EXPIRY_EPOCH - $CURRENT_EPOCH) / 86400 ))
            
            echo "‚úÖ SSL certificate exists"
            echo "   Expiry: $EXPIRY_DATE"
            echo "   Days remaining: $DAYS_LEFT"
            
            if [ "$DAYS_LEFT" -lt 30 ]; then
              echo "‚ö†Ô∏è  Certificate expiring soon - will renew"
              SHOULD_RENEW=true
            else
              echo "   ‚úì Certificate is valid, no renewal needed"
            fi
          fi
          
          # Request/renew SSL certificate only if needed
          if [ "$SHOULD_RENEW" = true ]; then
            echo "üîê Requesting/renewing SSL certificate from Let's Encrypt..."
            sudo certbot certonly \
              --non-interactive \
              --agree-tos \
              -m admin@dancingsalamanders.com \
              --webroot \
              -w /var/www/certbot \
              -d "$DOMAIN" \
              2>&1 || { echo "‚ùå Certbot failed - cert may not be available"; exit 1; }
            echo "‚úÖ Certificate issued/renewed successfully"
          fi
          
          # Create nginx configuration
          echo "üìù Creating nginx configuration..."
          
          # Use temporary config with or without SSL depending on cert availability
          if [ -f "$CERT_FILE" ]; then
            echo "   Using SSL configuration (cert available)"
            SSL_SECTION="
              # SSL configuration
              ssl_certificate /etc/letsencrypt/live/$DOMAIN/fullchain.pem;
              ssl_certificate_key /etc/letsencrypt/live/$DOMAIN/privkey.pem;
              ssl_session_timeout 1d;
              ssl_session_cache shared:SSL:50m;
              ssl_protocols TLSv1.2 TLSv1.3;
              ssl_ciphers HIGH:!aNULL:!MD5;
              ssl_prefer_server_ciphers on;
              add_header Strict-Transport-Security \"max-age=31536000; includeSubDomains\" always;"
            LISTEN="listen 443 ssl http2;"
          else
            echo "   ‚ö†Ô∏è  Cert not available yet - HTTP only (cert needed for HTTPS)"
            SSL_SECTION="# SSL configuration (certificates not yet available)"
            LISTEN="listen 80;"
          fi
          
          sudo tee "$NGINX_CONFIG" > /dev/null << 'NGINXEOF'
          # HTTP - Let's Encrypt verification and redirect to HTTPS
          server {
              listen 80;
              server_name littlelakehill.dancingsalamanders.com;
          
              # Let's Encrypt webroot for certificate verification
              location /.well-known/acme-challenge/ {
                  root /var/www/certbot;
              }
          
              # Redirect to HTTPS if cert is available
              location / {
                  return 301 https://$host$request_uri;
              }
          }
          
          # HTTPS/HTTP - Reverse proxy to application
          server {
              SERVER_LISTEN
              server_name littlelakehill.dancingsalamanders.com;
          
              SERVER_SSL_CONFIG
          
              # Reverse proxy to Docker container on port 3002
              location / {
                  proxy_pass http://127.0.0.1:3002;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_set_header X-Forwarded-Host $server_name;
                  
                  # WebSocket support
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection "upgrade";
                  
                  # Timeouts
                  proxy_connect_timeout 60s;
                  proxy_send_timeout 60s;
                  proxy_read_timeout 60s;
              }
          }
          NGINXEOF
          
          # Now apply variable substitution to the config
          sudo sed -i "s|SERVER_LISTEN|$LISTEN|g" "$NGINX_CONFIG"
          sudo sed -i "s|SERVER_SSL_CONFIG|$SSL_SECTION|g" "$NGINX_CONFIG"
          
          # Enable nginx site
          echo "üîó Enabling nginx site..."
          sudo ln -sf "$NGINX_CONFIG" "$NGINX_ENABLED"
          
          # Test nginx configuration
          echo "üß™ Testing nginx configuration..."
          if ! sudo nginx -t 2>&1 | grep "successful"; then
            echo "‚ùå Nginx configuration test failed!"
            sudo nginx -T
            exit 1
          fi
          
          # Reload nginx
          echo "üîÑ Reloading nginx..."
          sudo systemctl reload nginx
          
          # Verify setup
          echo "‚úÖ SSL and Nginx setup complete!"
          echo "   Config: $NGINX_CONFIG"
          echo "   Enabled: $NGINX_ENABLED"
          if [ -d "$CERT_PATH" ]; then
            echo "   Certificate: $CERT_PATH (valid)"
          else
            echo "   ‚ö†Ô∏è  Certificate not yet issued - may need manual certbot setup"
          fi
          SETUPEOF
          
          chmod +x setup_ssl.sh
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no setup_ssl.sh ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }}:~/setup_ssl.sh
          
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} \
            "bash ~/setup_ssl.sh"

      - name: Verify Deployment
        env:
          SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          echo "üîç Verifying deployment..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} << 'EOF'
          echo "üìã Docker containers:"
          sudo docker-compose -f /home/ubuntu/littlelakehill/docker-compose.yml ps 2>/dev/null || echo "   (containers not yet running)"
          
          echo ""
          echo "üåê Nginx status:"
          if sudo systemctl is-active --quiet nginx; then
            echo "   ‚úì Nginx is running"
          else
            echo "   ‚úó Nginx is not running"
          fi
          
          echo ""
          echo "üîê SSL Certificate status:"
          CERT_FILE="/etc/letsencrypt/live/littlelakehill.dancingsalamanders.com/fullchain.pem"
          if [ -f "$CERT_FILE" ]; then
            EXPIRY=$(sudo openssl x509 -in "$CERT_FILE" -noout -enddate 2>/dev/null | cut -d= -f2)
            EXPIRY_EPOCH=$(date -d "$EXPIRY" +%s 2>/dev/null || date -jf "%b %d %T %Z %Y" "$EXPIRY" +%s)
            CURRENT_EPOCH=$(date +%s)
            DAYS_LEFT=$(( ($EXPIRY_EPOCH - $CURRENT_EPOCH) / 86400 ))
            echo "   ‚úì Certificate exists"
            echo "   Expiry: $EXPIRY"
            echo "   Days remaining: $DAYS_LEFT"
          else
            echo "   ‚ö†Ô∏è  Certificate not yet available (may need manual certbot or DNS resolution)"
          fi
          
          echo ""
          echo "üìç Site accessibility:"
          echo "   HTTP: http://129.151.193.219:3002"
          echo "   HTTPS: https://littlelakehill.dancingsalamanders.com (requires valid cert)"
          
          echo ""
          echo "‚úÖ Verification complete!"
          EOF

      - name: Deployment Summary
        run: |
          echo "## üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Details:**" >> $GITHUB_STEP_SUMMARY
          echo "- **Host:** ${{ env.DEPLOY_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Domain:** https://${{ env.DOMAIN }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Theme:** ${{ github.event.inputs.theme }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Email Notifications:** ${{ github.event.inputs.enable_email }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment Path:** ${{ env.DEPLOY_PATH }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Ref:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
