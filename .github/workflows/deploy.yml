name: Deploy to Oracle Host

on:
  workflow_dispatch:
    inputs:
      theme:
        description: 'Theme Selection'
        required: true
        default: 'nordic-standard'
        type: choice
        options:
          - nordic-standard
          - nordic-minimal
          - adventure-bold
      enable_email:
        description: 'Enable Email Notifications'
        required: false
        default: false
        type: boolean

env:
  DEPLOY_HOST: 129.151.193.219
  DEPLOY_USER: ubuntu
  DEPLOY_PATH: /home/ubuntu/littlelakehill
  SERVICE_NAME: lits_camping
  HOST_PORT: 3002
  CONTAINER_PORT: 3000
  DOMAIN: littlelakehill.dancingsalamanders.com

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to Oracle Host
        env:
          SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          THEME: ${{ github.event.inputs.theme }}
          ENABLE_EMAIL: ${{ github.event.inputs.enable_email }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.DEPLOY_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          
          # Copy deploy script to remote and execute
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no .github/scripts/deploy.sh ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }}:~/deploy.sh
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} \
            bash ~/deploy.sh "$THEME" "$ENABLE_EMAIL" "$DB_PASSWORD" "$NEXTAUTH_SECRET"

      - name: Setup Nginx & SSL Certificates
        env:
          SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no .github/scripts/setup-ssl.sh ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }}:~/setup-ssl.sh
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} bash ~/setup-ssl.sh

      - name: Verify Deployment
        env:
          SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          echo "Verification complete!"

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Details:**" >> $GITHUB_STEP_SUMMARY
          echo "- **Host:** ${{ env.DEPLOY_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Domain:** https://${{ env.DOMAIN }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Theme:** ${{ github.event.inputs.theme }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Email Notifications:** ${{ github.event.inputs.enable_email }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment Path:** ${{ env.DEPLOY_PATH }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Ref:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
